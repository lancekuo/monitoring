version: '3.1'
services:
    grafana:
        image: "grafana/grafana:4.2.0"
        volumes:
            - "/opt/grafana:/var/lib/grafana"
        environment:
            - "GF_SECURITY_ADMIN_PASSWORD=test"
        ports:
            - "3000:3000"
        networks: 
            - prom
        deploy:
            placement:
                constraints:
                    - node.labels.type == internal
    prom:
        build: prometheus/
        image: "lancekuo/prometheus:1.6.1-1"
        volumes:
            - "/opt/prometheus:/prometheus"
        ports:
            - "9090:9090"
        networks: 
            - prom
        deploy:
            placement:
                constraints:
                    - node.labels.type == storage
    node:
        image: "prom/node-exporter"
        command: 
            - '-collector.procfs=/host/proc'
            - '-collector.sysfs=/host/sys'
            - '-collector.filesystem.ignored-mount-points="^/(sys|proc|dev|host|etc)($$|/)"'
            - '--collectors.enabled=conntrack,diskstats,entropy,filefd,filesystem,loadavg,mdadm,meminfo,netdev,netstat,stat,textfile,time,vmstat,ipvs'
        volumes:
            - /proc:/host/proc
            - /sys:/host/sys
            - /:/rootfs
            - /etc/hostname:/etc/host_hostname
        environment:
            - "HOST_HOSTNAME=/etc/host_hostname"
        networks: 
            - prom
        deploy:
            mode: global
            restart_policy:
                condition: on-failure
                delay: 5s
                max_attempts: 3
                window: 10s
            update_config:
                parallelism: 2
                delay: 10s

    cadvisor:
        image: "google/cadvisor:latest"
        volumes:
            - /var/lib/docker:/var/lib/docker
            - /var/run:/var/run
            - /sys:/sys
            - /:/rootfs
        networks: 
            - prom
        deploy:
            mode: global
            restart_policy:
                condition: on-failure
                delay: 5s
                max_attempts: 3
                window: 10s
            update_config:
                parallelism: 2
                delay: 10s
networks:
    prom:
        driver: overlay

